<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lab 1 — Toxicology & Early Diagnostics (Final, Scrolling Chart)</title>
<style>
:root{
  --bg:#f4f7fb; --card:#fff; --accent:#2563eb; --accent2:#06b6d4; --danger:#ef4444; --muted:#6b7280;
  --health:#27ae60; --coord:#3b82f6; --hrcol:#ef4444;
}
html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#eef8ff,#fbfeff);color:#07203a}
.wrap{max-width:1200px;margin:12px auto;padding:12px}
header{display:flex;align-items:center;gap:12px}
h1{margin:0;font-size:20px}
.disclaimer{background:#fff7f7;border-left:4px solid var(--danger);padding:10px;border-radius:8px;margin:10px 0;color:#7b1a1a}
.layout{display:grid;grid-template-columns:1fr 480px;gap:12px}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 8px 26px rgba(6,10,25,0.06)}
.left{min-height:680px}
.visualWrap{display:flex;flex-direction:column;align-items:center;gap:8px;padding:8px}
.ratStage{position:relative;width:340px;height:340px;display:flex;align-items:center;justify-content:center}
.ratGroup{position:relative;width:270px;height:270px}
.body{position:absolute;left:45px;top:95px;width:160px;height:120px;border-radius:80px 80px 40px 40px;background:#e6e1dd;transition:transform .12s linear}
.head{position:absolute;left:20px;top:40px;width:86px;height:86px;border-radius:50%;background:#e6e1dd;transition:transform .18s ease}
.ear{position:absolute;width:26px;height:22px;border-radius:50%;background:#ffd7e5;top:6px}
.ear.l{left:8px}
.ear.r{right:8px}
.eye{position:absolute;width:8px;height:8px;border-radius:50%;background:#0b1220;top:38px}
.eye.l{left:26px}
.eye.r{right:26px}
.tail{position:absolute;right:-40px;bottom:56px;width:12px;height:120px;background:#f1cdbd;border-radius:12px;transform:rotate(18deg);transform-origin:left;transition:transform .12s linear}
@keyframes breathe{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
.breathe{animation:breathe 2600ms infinite ease-in-out}
@keyframes twitch{0%{transform:translateY(0)}10%{transform:translateY(-3px)}20%{transform:translateY(0)}}
.twitchy{animation:twitch 900ms steps(2) infinite}
@keyframes pulseAnim{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
.pulse{animation:pulseAnim 700ms ease-in-out 1}
.headTilt{transform:rotate(6deg)}
@keyframes confusion{0%{transform:translateX(0)}50%{transform:translateX(2px)}100%{transform:translateX(0)}}
.confuse{animation:confusion 1400ms ease-in-out 1}
.paleEar{background:#f3d6d6}

/* tools */
.tray{display:flex;gap:10px;align-items:center}
.syringe{width:120px;height:36px;border-radius:8px;background:linear-gradient(90deg,#fff,#e6f7ff);border:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:center;cursor:grab}
.pill{width:100px;height:36px;border-radius:8px;background:linear-gradient(90deg,#fff,#fff3c4);border:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:center;cursor:grab}
.kit{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;background:linear-gradient(90deg,#fee2e2,#fecaca);border:1px solid rgba(6,10,25,0.06);cursor:pointer}
.kit.disabled{opacity:.35;pointer-events:none}

/* right side */
.vitals{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.stat{background:linear-gradient(180deg,#fff,#fbfdff);padding:8px;border-radius:8px;border:1px solid rgba(6,10,25,0.03)}
.barWrap{height:12px;background:#f1f5f9;border-radius:999px;overflow:hidden;margin-top:6px}
.barFill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));width:100%}
.small{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(6,10,25,0.06);color:#07203a}
.chart{margin-top:10px;background:#021724;color:#cfefff;padding:8px;border-radius:8px}
canvas{width:100%;height:200px;border-radius:6px;background:transparent}
.log{margin-top:10px;background:linear-gradient(180deg,#fff,#f6fbff);padding:8px;border-radius:8px;height:150px;overflow:auto;font-size:13px}
.bottomActions{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.arrow{padding:8px 12px;border-radius:8px;background:linear-gradient(90deg,#60a5fa,#7c3aed);color:white;text-decoration:none;opacity:.45;pointer-events:none}
.arrow.enabled{opacity:1;pointer-events:auto}
.overlay{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:80}
.report{width:820px;max-width:94%;background:white;padding:16px;border-radius:10px;box-shadow:0 16px 60px rgba(2,6,23,0.35)}
.reportSection{margin-top:12px;padding:10px;border-radius:8px;background:#fbfdff;border:1px solid rgba(6,10,25,0.04)}
.muted{color:var(--muted)}
@media(max-width:980px){ .layout{grid-template-columns:1fr} .ratStage{width:260px;height:260px} }
</style>
</head>
<body>
<div class="wrap">
  <header><h1>Lab 1 — Toxicology & Early Diagnostics</h1></header>

  <div class="disclaimer card">
    <strong>Safety:</strong> Educational simulation only. Doses are simulation units/kg and not real-world instructions. Genetic diagnoses are hidden in Lab 1; Lab 3 confirms them.
  </div>

  <div class="layout">
    <!-- LEFT -->
    <div class="card left">
      <div class="visualWrap">
        <div style="display:flex;justify-content:space-between;align-items:center;width:100%">
          <div class="small muted">Specimen visual — watch for subtle behavior & vitals</div>
          <div>
            <label class="small muted">Mutation spawn chance</label><br>
            <input id="mutChance" type="range" min="0" max="15" value="9" style="width:180px"><span class="small muted" id="mutLabel">9%</span>
          </div>
        </div>

        <div id="ratStage" class="ratStage card" aria-label="Animated specimen">
          <div class="ratGroup">
            <div id="ratBody" class="body breathe"></div>
            <div id="ratHead" class="head"><div id="earL" class="ear l"></div><div id="earR" class="ear r"></div><div id="eyeL" class="eye l"></div><div id="eyeR" class="eye r"></div></div>
            <div id="ratTail" class="tail"></div>
            <div id="reactBubble" style="position:absolute;left:40px;top:8px;background:rgba(0,0,0,0.7);color:#fff;padding:6px 8px;border-radius:8px;display:none;font-size:13px">eek!</div>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;width:100%">
          <div class="tray">
            <div id="pill" class="pill" draggable="true" title="Drag to rat for oral dose">PILL</div>
            <div id="syringe" class="syringe" draggable="true" title="Drag to rat to inject">
              <div style="display:flex;align-items:center;gap:8px">
                <div style="width:12px;height:18px;background:#cbd5e1;border-radius:2px"></div>
                <div style="font-weight:700">SYRINGE</div>
              </div>
            </div>
            <div id="kit" class="kit" title="Emergency stabilizer (one use)">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="display:block"><rect x="1" y="3" width="22" height="18" rx="3" fill="#fff" stroke="#ef4444"/><rect x="6" y="8" width="12" height="8" rx="1.2" fill="#fecaca"/><path d="M12 10v6M9 13h6" stroke="#b91c1c" stroke-width="1.6" stroke-linecap="round"/></svg> FIRST AID
            </div>
          </div>

          <div style="width:360px">
            <label class="small muted">Drug</label>
            <select id="drugSelect" style="width:100%;padding:8px;border-radius:8px">
              <option value="caffeine">Caffeine</option>
              <option value="diazepam">Diazepam</option>
              <option value="morphine">Morphine</option>
              <option value="ketamine">Ketamine</option>
              <option value="amphetamine">Amphetamine</option>
              <option value="nicotine">Nicotine</option>
            </select>

            <div style="display:flex;gap:8px;margin-top:8px">
              <div style="flex:1">
                <label class="small muted">Route</label>
                <select id="routeSelect" style="width:100%;padding:8px;border-radius:8px">
                  <option value="oral">Oral</option>
                  <option value="injection">Injection</option>
                  <option value="inhalation">Inhalation</option>
                </select>
              </div>
              <div style="width:130px">
                <label class="small muted">Dose (units/kg)</label>
                <input id="dose" type="number" value="1.0" step="0.1" style="width:100%;padding:8px;border-radius:8px">
              </div>
            </div>

            <div class="controls" style="margin-top:8px"><button id="giveBtn" class="btn">Give (click)</button>
<button id="saveBtn" class="btn ghost" onclick="sendToLab3()">Save & Send to Lab 3</button>
<button id="dnaBtn" class="btn ghost" onclick="sendToLab2()">Send DNA → Lab 2</button>
              
            </div>
          </div>
        </div>

        <div class="small muted" style="width:100%;text-align:left;margin-top:8px">Drag the pill or syringe to the specimen to administer. Stabilizer in the red kit is single-use.</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Specimen info & vitals</strong><div class="small muted">Observations only — genetic labels hidden in Lab 1.</div></div>
        <div class="small muted">ID: <input id="specId" style="width:120px;padding:6px;border-radius:6px;border:1px solid #e6eef7"></div>
      </div>

      <div class="vitals" style="margin-top:8px">
        <div class="stat"><strong>Health</strong><div class="barWrap"><div id="healthBar" class="barFill" style="width:100%;background:linear-gradient(90deg,var(--health),#0ea85a)"></div></div><div id="healthText" class="small">100%</div></div>
        <div class="stat"><strong>Coordination</strong><div class="barWrap"><div id="coordBar" class="barFill" style="width:100%;background:linear-gradient(90deg,var(--coord),#60a5fa)"></div></div><div id="coordText" class="small">100%</div></div>
        <div class="stat"><strong>Heart rate</strong><div id="hrText" class="small">320 BPM</div></div>
        <div class="stat"><strong>Blood pressure</strong><div id="bpText" class="small">110 / 70</div></div>
        <div class="stat"><strong>Liver load</strong><div class="barWrap"><div id="liverBar" class="barFill" style="width:0%"></div></div><div id="liverText" class="small">0%</div></div>
        <div class="stat"><strong>Brain load</strong><div class="barWrap"><div id="brainBar" class="barFill" style="width:0%"></div></div><div id="brainText" class="small">0%</div></div>
      </div>

      <div class="chart card" style="margin-top:12px">
        <strong>Live monitor — last 60s (Health / Coordination / Heart Rate)</strong>
        <canvas id="chart" width="540" height="200"></canvas>
      </div>

      <div class="log">
        <strong>Event log (actions & measurements only)</strong>
        <div id="logArea" style="margin-top:8px"></div>
      </div>

      <div class="bottomActions">
        <div class="small muted">Saved cases stored in <code>lab3_pending_case</code> (localStorage) for Lab 3 import.</div>
        <div>
          <a id="arrow2" class="arrow" href="#" title="Lab 2 (placeholder)">← Lab 2</a>
          <a id="arrow3" class="arrow" href="#" title="Lab 3 (placeholder)" style="margin-left:8px">Lab 3 →</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* Lab 1 — Final build with continuous-scrolling straight-line chart showing last windowSeconds (default 60s).
   Features: congenital hints, drag & drop syringe/pill, stabilizer, PK/PD, post-mortem, save-to-Lab3, Save postmortem.
*/

// Helpers
const $ = id => document.getElementById(id);
function log(msg){ const d=document.createElement('div'); d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`; $('logArea').prepend(d); }
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function now(){return Date.now()/1000;}

// Config & pools
const windowSeconds = 60; // visible time window for chart (last N seconds)
const MUT_DEFAULT = 9;
$('mutChance').value = MUT_DEFAULT;
$('mutLabel').textContent = MUT_DEFAULT + '%';

const CONGENITAL_POOL = {
  'down-like': {label:'Down-like', effect:{coord:-8,hr:0,breathIrreg:0.02}, visual:'headTilt', intermittency:0.02},
  'cf-like': {label:'CF-like', effect:{coord:-5,hr:+6,breathIrreg:0.08}, visual:'breathIrregular', intermittency:0.03},
  'dementia-like': {label:'Dementia-like', effect:{coord:-10,hr:0,breathIrreg:0.01}, visual:'confuse', intermittency:0.02},
  'parkinson-like': {label:'Parkinson-like', effect:{coord:-12,hr:0,breathIrreg:0.01}, visual:'twitch', intermittency:0.08},
  'sickle-like': {label:'Sickle-like', effect:{coord:-10,hr:+8,breathIrreg:0.01}, visual:'paleEar', intermittency:0.015}
};

const DRUGS = {
  caffeine: {name:'Caffeine', potency:0.7, halfLife:4, effects:{coord:+0.25,hr:+0.25,brain:+0.12,liver:+0.06}, mut:0.0001},
  diazepam: {name:'Diazepam', potency:1.0, halfLife:40, effects:{coord:-0.6,hr:-0.3,brain:+0.18,liver:+0.12}, mut:0.00005},
  morphine: {name:'Morphine', potency:1.0, halfLife:12, effects:{coord:-0.4,hr:-0.25,brain:+0.2,liver:+0.18}, mut:0.0001},
  ketamine: {name:'Ketamine', potency:1.1, halfLife:16, effects:{coord:-0.55,hr:+0.05,brain:+0.2,liver:+0.14}, mut:0.00015},
  amphetamine: {name:'Amphetamine', potency:1.15, halfLife:6, effects:{coord:+0.6,hr:+0.9,brain:+0.28,liver:+0.08}, mut:0.0002},
  nicotine: {name:'Nicotine', potency:0.9, halfLife:1.5, effects:{coord:+0.3,hr:+0.6,brain:+0.25,liver:+0.22}, mut:0.0005}
};

// State
let specimen = {};
let active = []; // {drugKey,mag,decay,when,route}
let history = []; // {t,health,coord,hr}
let stabilizerUsed = false;
let last = now();

// Spawn (neutral wording)
function spawn(){
  specimen = {
    id: 'RAT-' + Math.floor(Math.random()*90000+1000),
    weight_g: 300,
    sex: Math.random()<0.5?'Male':'Female',
    health: 100,
    coord: 100,
    hr: Math.round(300 + Math.random()*30),
    bp_sys: 110, bp_dia:70,
    rr: Math.round(60 + Math.random()*25),
    liver: 0,
    brain: 0,
    drugConc: 0,
    t: 0,
    mutationKey: null,
    mutation: null,
    _dead: false,
    _maskUntil: 0
  };
  const chance = Number($('mutChance').value);
  if(Math.random()*100 < chance){
    const keys = Object.keys(CONGENITAL_POOL);
    const pick = keys[Math.floor(Math.random()*keys.length)];
    specimen.mutationKey = pick;
    specimen.mutation = CONGENITAL_POOL[pick];
    specimen.coord = clamp(specimen.coord + (specimen.mutation.effect.coord||0), 0, 100);
    specimen.hr = clamp(specimen.hr + (specimen.mutation.effect.hr||0), 30, 900);
  }
  log('New subject entered testing chamber.');
  stabilizerUsed = false; $('kit').classList.remove('disabled');
  $('specId').value = specimen.id; active=[]; history=[];
  updateUI(); drawChart();
}

// Administer
function computeMag(dose,drug,route){
  const routeMod = (route==='injection')?1.0:(route==='oral')?0.75:0.85;
  const pot = DRUGS[drug].potency;
  return dose * routeMod * pot;
}
function administer(drugKey,dosePerKg,route,method){
  if(!DRUGS[drugKey]) return;
  const mag = computeMag(dosePerKg, drugKey, route);
  const half = DRUGS[drugKey].halfLife;
  const decay = Math.log(2)/Math.max(0.05, half);
  active.push({drugKey,mag,decay,when:now(),route});
  log(`${DRUGS[drugKey].name} administered (${method}). Dose: ${dosePerKg} units/kg.`);
  const eff = DRUGS[drugKey].effects;
  specimen.coord = clamp(specimen.coord + (eff.coord||0)*mag*0.12,0,100);
  specimen.hr = Math.round(clamp(specimen.hr + (eff.hr||0)*mag*5,30,900));
}

// Stabilizer
function useStabilizer(){
  if(stabilizerUsed) return;
  stabilizerUsed = true; $('kit').classList.add('disabled');
  specimen.health = clamp(specimen.health + 15,0,100);
  specimen.coord = clamp(specimen.coord + 15,0,100);
  active.forEach(a=>a.mag *= 0.6);
  specimen._maskUntil = Date.now() + 4000;
  showReact('stabilizer'); log('Stabilizer administered — vitals partially recovered.');
  updateUI();
}

// Drag & drop wiring
const pill = $('pill'), syringe = $('syringe'), ratStage = $('ratStage'), kit = $('kit');
[pill,syringe].forEach(el=>{
  el.addEventListener('dragstart', e=> { e.dataTransfer.setData('text/plain', el.id); el.classList.add('dragging'); });
  el.addEventListener('dragend', e=> el.classList.remove('dragging'));
});
ratStage.addEventListener('dragover', e=> e.preventDefault());
ratStage.addEventListener('drop', e=>{
  e.preventDefault();
  const id = e.dataTransfer.getData('text/plain');
  if(id==='pill'){ const drug=$('drugSelect').value, dose=Number($('dose').value)||0; administer(drug,dose,'oral','pill-drag'); showReact('pill'); }
  else if(id==='syringe'){ const drug=$('drugSelect').value, dose=Number($('dose').value)||0; administer(drug,dose,'injection','syringe-drag'); showReact('syringe'); }
});
// Buttons
$('giveBtn').addEventListener('click', ()=> { const drug=$('drugSelect').value, dose=Number($('dose').value)||0, route=$('routeSelect').value; administer(drug,dose,route,'click-give'); });
$('kit').addEventListener('click', ()=> useStabilizer());
$('dnaBtn').addEventListener('click', ()=> {
  const ref = {id: specimen.id, weight_g: specimen.weight_g, sex: specimen.sex, health: specimen.health, coord: specimen.coord, hr: specimen.hr, time: Date.now()};
  try{ localStorage.setItem('lab2_pending_referral', JSON.stringify(ref)); log('DNA swab saved for Lab 2 (lab2_pending_referral).'); }catch(e){ log('Save failed.'); }
});
$('saveBtn').addEventListener('click', ()=> {
  const caseObj = { id: specimen.id, weight_g: specimen.weight_g, sex: specimen.sex, health: specimen.health, coord: specimen.coord, hr: specimen.hr, bp: specimen.bp_sys+'/'+specimen.bp_dia, rr: specimen.rr, liver: specimen.liver, brain: specimen.brain, drugConc: specimen.drugConc, time: Date.now(), history: history.slice(), mutationKey: specimen.mutationKey || null };
  try{ localStorage.setItem('lab3_pending_case', JSON.stringify(caseObj)); log('Case saved for Lab 3 (lab3_pending_case).'); }catch(e){ log('Save failed.'); }
  const txt = `ID: ${caseObj.id}\nWeight_g: ${caseObj.weight_g}\nSex: ${caseObj.sex}\nHealth: ${caseObj.health}\nCoord: ${caseObj.coord}\nHR: ${caseObj.hr}\nBP: ${caseObj.bp}\nRR: ${caseObj.rr}\nLiver:${caseObj.liver}\nBrain:${caseObj.brain}\nNote: Saved from Lab1\n`;
  const blob = new Blob([txt],{type:'text/plain'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${caseObj.id}_lab1_snapshot.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  log('Case snapshot downloaded (.txt).');
});
// Reactions
function showReact(kind){
  const b = $('reactBubble'); b.style.display='block'; b.textContent = kind==='pill'?'nom':'eek';
  setTimeout(()=> b.style.display='none',800);
  const body = $('ratBody'); body.classList.add('pulse'); setTimeout(()=> body.classList.remove('pulse'),700);
}
<button id="giveBtn" class="btn">Give (click)</button>
<button id="saveBtn" class="btn ghost" onclick="sendToLab3()">Save & Send to Lab 3</button>
<button id="dnaBtn" class="btn ghost" onclick="sendToLab2()">Send DNA → Lab 2</button>
// Visual hint triggers
function triggerBreathIrregular(){ const b=$('ratBody'); b.style.animationDuration='1200ms'; setTimeout(()=> b.style.animationDuration='2600ms',900); }
function triggerTwitch(){ const b=$('ratBody'); b.classList.add('twitchy'); setTimeout(()=> b.classList.remove('twitchy'),1200); }
function triggerHeadTilt(){ const hd=$('ratHead'); hd.classList.add('headTilt'); setTimeout(()=> hd.classList.remove('headTilt'),900); }
function triggerConfuse(){ const hd=$('ratHead'); hd.classList.add('confuse'); setTimeout(()=> hd.classList.remove('confuse'),900); }
function triggerPaleEar(){ $('earL').classList.add('paleEar'); $('earR').classList.add('paleEar'); setTimeout(()=> {$('earL').classList.remove('paleEar'); $('earR').classList.remove('paleEar');},2200); }

// Chart (continuous sliding over last windowSeconds seconds)
const canvas = $('chart'); const ctx = canvas.getContext('2d');
function drawChart(){
  const w = canvas.width = canvas.clientWidth; const h = canvas.height = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = '#021724'; ctx.fillRect(0,0,w,h);
  if(history.length < 2) return;
  const tNow = history[history.length-1].t;
  const tStart = tNow - windowSeconds;
  // draw axes faint grid (vertical lines every 10s)
  ctx.strokeStyle = 'rgba(255,255,255,0.04)'; ctx.lineWidth = 1;
  for(let s = Math.ceil(tStart); s <= tNow; s+=10){
    const x = ((s - tStart)/windowSeconds) * (w-14) + 7;
    ctx.beginPath(); ctx.moveTo(x,8); ctx.lineTo(x,h-8); ctx.stroke();
  }
  // helper map function
  const mapX = t => ((t - tStart)/windowSeconds) * (w-14) + 7;
  const mapY = v => h - (v/100)*(h-28) - 14;
  // draw health line
  ctx.beginPath(); ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--health')||'#27ae60'; ctx.lineWidth=2;
  let started=false;
  for(let i=0;i<history.length;i++){
    const p = history[i];
    if(p.t < tStart) continue;
    const x = mapX(p.t), y = mapY(p.health);
    if(!started){ ctx.moveTo(x,y); started=true; } else ctx.lineTo(x,y);
  }
  ctx.stroke();
  // coordination
  ctx.beginPath(); ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--coord')||'#3b82f6'; ctx.lineWidth=2;
  started=false;
  for(let i=0;i<history.length;i++){
    const p = history[i];
    if(p.t < tStart) continue;
    const x = mapX(p.t), y = mapY(p.coord);
    if(!started){ ctx.moveTo(x,y); started=true; } else ctx.lineTo(x,y);
  }
   ctx.stroke();
  // heart rate mapped to 0..100 for visualization
  ctx.beginPath(); ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--hrcol')||'#ef4444'; ctx.lineWidth=1.6;
  started=false;
  for(let i=0;i<history.length;i++){
    const p = history[i];
    if(p.t < tStart) continue;
    const hrMapped = clamp((p.hr - 150)/5, 0, 100);
    const x = mapX(p.t), y = mapY(hrMapped);
    if(!started){ ctx.moveTo(x,y); started=true; } else ctx.lineTo(x,y);
  }
  ctx.stroke();
}

// Update UI
  <a href="../lab2/index.html">Go to Lab 2</a>
  
function exportCaseData(){
  // --- 1. Gather session summary ---
  const bpValues = history.map(h => `${h.bp_sys}/${h.bp_dia}`);
  const bpNumbers = history.map(h => ({ sys: h.bp_sys, dia: h.bp_dia }));
  const hrValues = history.map(h => h.hr);

  const minBP = bpNumbers.reduce((a, b) => a.sys < b.sys ? a : b);
  const maxBP = bpNumbers.reduce((a, b) => a.sys > b.sys ? a : b);
  const minHR = Math.min(...hrValues);
  const maxHR = Math.max(...hrValues);

  let summary = `Specimen ID: ${specimen.id}\nSession Date: ${new Date().toLocaleString()}\n\n`;
  summary += `Vitals Summary:\n`;
  summary += `  BP: low ${minBP.sys}/${minBP.dia} — high ${maxBP.sys}/${maxBP.dia}\n`;
  summary += `  HR: low ${minHR} bpm — high ${maxHR} bpm\n`;
  summary += `  Coordination: ${Math.round(specimen.coord)}%\n`;
  summary += `  Health Index: ${Math.round(specimen.health)}%\n\n`;

  summary += `Session Observations:\n`;
  summary += `  ${eventLog.filter(e => !e.toLowerCase().includes("diagnosis")).join("\n  ")}\n\n`;

  summary += `Conclusion Prompt:\n`;
  summary += `  — No definitive diagnosis. Continue investigation. —\n\n`;

  const notes = document.getElementById("pmNotesInput")?.value || "";
  summary += `Notes (player):\n${notes}\n`;

  // --- 2. Save TXT file ---
  const txtBlob = new Blob([summary], { type: "text/plain" });
  const txtUrl = URL.createObjectURL(txtBlob);
  const txtLink = document.createElement("a");
  txtLink.href = txtUrl;
  txtLink.download = `Specimen_${specimen.id}_Session.txt`;
  txtLink.click();

  // --- 3. Save Frozen Chart as PNG ---
  if (frozenCanvas) {
    const imgUrl = frozenCanvas.toDataURL("image/png");
    const imgLink = document.createElement("a");
    imgLink.href = imgUrl;
    imgLink.download = `Specimen_${specimen.id}_Vitals.png`;
    imgLink.click();
  }
  }
  exportCaseData(notes); // Save TXT + PNG (with notes)
  function sendToLab2(){
  exportCaseData(); // save both txt + png before leaving
  window.location.href = "lab2.html"; 
}

function sendToLab3(){
  exportCaseData(); // save both txt + png before leaving
  window.location.href = "lab3.html";
}

  const caseObj = { 
    id: specimen.id, 
    weight_g: specimen.weight_g, 
    sex: specimen.sex, 
    health: specimen.health, 
    coord: specimen.coord, 
    hr: specimen.hr, 
    bp: specimen.bp_sys+'/'+specimen.bp_dia, 
    rr: specimen.rr, 
    liver: specimen.liver, 
    brain: specimen.brain, 
    drugConc: specimen.drugConc, 
    time: Date.now(), 
    history: history.slice(), 
    interventions: interventions.slice(),
    notes: notes || ""
  };
  try { 
    localStorage.setItem('lab2_pending_case', JSON.stringify(caseObj)); 
    log('Case saved for Lab 2 (lab2_pending_case).'); 
  } catch(e) { 
    log('Save failed.'); 
  }

  window.location.href = "lab2.html"; 
}

function sendToLab3(){
  const notes = prompt("Enter any notes for this specimen before sending to Lab 3:", getPlayerNotes() || "");
  if (notes !== null) {
    setPlayerNotes(notes); // if you have this helper, store the notes
  }

  exportCaseData(notes); // Save TXT + PNG (with notes)

  const caseObj = { 
    id: specimen.id, 
    weight_g: specimen.weight_g, 
    sex: specimen.sex, 
    health: specimen.health, 
    coord: specimen.coord, 
    hr: specimen.hr, 
    bp: specimen.bp_sys+'/'+specimen.bp_dia, 
    rr: specimen.rr, 
    liver: specimen.liver, 
    brain: specimen.brain, 
    drugConc: specimen.drugConc, 
    time: Date.now(), 
    history: history.slice(), 
    interventions: interventions.slice(),
    notes: notes || ""
  };
  try { 
    localStorage.setItem('lab3_pending_case', JSON.stringify(caseObj)); 
    log('Case saved for Lab 3 (lab3_pending_case).'); 
  } catch(e) { 
    log('Save failed.'); 
  }

  window.location.href = "lab3.html"; 
}
function updateUI(){
  if(!specimen.id) return;
  $('specId').value = specimen.id;
  $('healthText').textContent = Math.round(specimen.health) + '%';
  $('coordText').textContent = Math.round(specimen.coord) + '%';
  $('healthBar').style.width = specimen.health + '%';
  $('coordBar').style.width = specimen.coord + '%';
  $('hrText').textContent = specimen.hr + ' BPM';
  $('bpText').textContent = specimen.bp_sys + ' / ' + specimen.bp_dia;
  $('liverText').textContent = Math.round(specimen.liver) + '%';
  $('brainText').textContent = Math.round(specimen.brain) + '%';
  $('liverBar').style.width = specimen.liver + '%';
  $('brainBar').style.width = specimen.brain + '%';
  const body = $('ratBody'), tail = $('ratTail');
  const breatheSpeed = clamp(2600 - (specimen.rr-60)*8 - (100-specimen.health)*6, 900, 3800);
  body.style.animationDuration = (breatheSpeed)+'ms';
  const tailRot = 18 + (100 - specimen.coord)*0.06;
  tail.style.transform = `rotate(${tailRot}deg)`;
}

// --- Session Summary (replaces old Post-mortem)
function determineSessionPrompt(){
  // Optional subtle prompt — can be removed after a few cases to force player deduction
  const prompts = [
    "No definitive diagnosis. Continue investigation.",
    "Consider running additional cardiovascular and coordination tests.",
    "Further lab work recommended — send to Lab 2 or Lab 3."
  ];
  return prompts[Math.floor(Math.random() * prompts.length)];
}

function showPostMortem(){
  $('overlay').style.display = 'flex';

  // Vitals summary from history
  const bpValues = history.map(p => p.bp_sys);
  const bpMin = Math.min(...bpValues);
  const bpMax = Math.max(...bpValues);
  const hrValues = history.map(p => p.hr);
  const hrMin = Math.min(...hrValues);
  const hrMax = Math.max(...hrValues);

  $('pmVitalsBody').innerHTML = `
    ID: ${specimen.id}<br>
    Weight (g): ${specimen.weight_g || 300}<br>
    BP: low ${bpMin}/${specimen.bp_dia} — high ${bpMax}/${specimen.bp_dia}<br>
    HR: low ${hrMin} bpm — high ${hrMax} bpm<br>
    Coordination: ${Math.round(specimen.coord)}%<br>
    Health Index: ${Math.round(specimen.health)}%
  `;

  $('pmCauseBody').textContent = determineSessionPrompt();

  $('pmOrgansBody').innerHTML = `
    Liver load: ${Math.round(specimen.liver)}%<br>
    Brain load: ${Math.round(specimen.brain)}%<br>
    Drug conc (sim): ${specimen.drugConc}
  `;

  $('pmNotesBody').innerHTML = `
    Genetic diagnosis remains hidden until Lab 3 sequencing.<br><br>
    <strong>Notes (player):</strong><br>
    <textarea id="playerNotes" style="width:100%;height:80px"></textarea>
  `;

  // Save the frozen chart from the whole session
  drawFrozenChart();
}

// Capture notes when exporting to other labs
function getPlayerNotes(){
  const notesField = document.getElementById('playerNotes');
  return notesField ? notesField.value.trim() : '';
}

// Modify your export function to include notes
function exportCaseData(){
  const playerNotes = getPlayerNotes();

  const bpValues = history.map(p => p.bp_sys);
  const bpMin = Math.min(...bpValues);
  const bpMax = Math.max(...bpValues);
  const hrValues = history.map(p => p.hr);
  const hrMin = Math.min(...hrValues);
  const hrMax = Math.max(...hrValues);

  const content = `
Specimen ID: ${specimen.id}
Weight (g): ${specimen.weight_g || 300}

Vitals Summary:
  BP: low ${bpMin}/${specimen.bp_dia} — high ${bpMax}/${specimen.bp_dia}
  HR: low ${hrMin} bpm — high ${hrMax} bpm
  Coordination: ${Math.round(specimen.coord)}%
  Health Index: ${Math.round(specimen.health)}%

Organ Loads:
  Liver: ${Math.round(specimen.liver)}%
  Brain: ${Math.round(specimen.brain)}%
  Drug concentration (sim): ${specimen.drugConc}

Session Prompt:
  ${determineSessionPrompt()}

Notes (player):
  ${playerNotes || '[No notes entered]'}
  `;

  const blob = new Blob([content], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `Specimen_${specimen.id}_Session.txt`;
  a.click();
}
}
$('closeReport').addEventListener('click', ()=> $('overlay').style.display='none');
$('downloadReport').addEventListener('click', ()=>{
  let content = `Post-mortem Report\nSubject: ${specimen.id}\nWeight: ${specimen.weight_g||300} g\nFinal health: ${Math.round(specimen.health)}%\nCoord: ${Math.round(specimen.coord)}%\nHR: ${specimen.hr} BPM\nBP: ${specimen.bp_sys}/${specimen.bp_dia}\nRR: ${specimen.rr}\nLiver: ${Math.round(specimen.liver)}%\nBrain: ${Math.round(specimen.brain)}%\n\nTimeseries (t,health,coord,hr):\n`;
  history.forEach(h => content += `${h.t}\t${Math.round(h.health)}\t${Math.round(h.coord)}\t${h.hr}\n`);
  content += `\nNote: Genetic diagnosis remains hidden until Lab 3.\n`;
  const blob = new Blob([content],{type:'text/plain'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${specimen.id}_postmortem.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
<a href="lab2/index.html">Go to Lab 2</a>
// Arrows placeholders
$('arrow2').addEventListener('click', e=>{ e.preventDefault(); log('Lab 2 placeholder — save referral to import when Lab 2 is ready.'); });
$('arrow3').addEventListener('click', e=>{ e.preventDefault(); log('Lab 3 placeholder — save case to import when Lab 3 is ready.'); });

// Mut chance UI
$('mutChance').addEventListener('input', e=> $('mutLabel').textContent = e.target.value + '%');
  // Simulation loop
function loop(){
  const cur = now(); const dt = Math.max(0.04, cur - last); last = cur;
  // process active drugs
  let totalConc = 0;
  for(let i=active.length-1;i>=0;i--){
    const a = active[i];
    const kg = Math.max(0.05, specimen.weight_g/1000 || 0.3);
    let conc = a.mag / kg;
    const eff = DRUGS[a.drugKey].effects;
    specimen.coord = clamp(specimen.coord + ((eff.coord||0)*conc*dt*0.35),0,100);
    specimen.hr = Math.round(clamp(specimen.hr + ((eff.hr||0)*conc*dt*18),30,900));
    specimen.liver = clamp(specimen.liver + ((eff.liver||0)*conc*dt*10),0,100);
    specimen.brain = clamp(specimen.brain + ((eff.brain||0)*conc*dt*10),0,100);
    specimen.health = clamp(specimen.health + ((eff.health||0)*conc*dt*0.9),0,100);
    totalConc += conc;
    if(conc > 1.5 && Math.random() < (DRUGS[a.drugKey].mut * dt * 60)){
      specimen.health = clamp(specimen.health - 2,0,100);
      log('Small DNA damage event recorded (simulation).');
    }
    a.mag *= Math.exp(-a.decay * dt);
    if(a.mag < 0.01) active.splice(i,1);
  }
  specimen.drugConc = parseFloat(totalConc.toFixed(3));
  if(specimen.liver > 60) specimen.health = clamp(specimen.health - 0.08*dt,0,100);
  if(specimen.brain > 60) specimen.coord = clamp(specimen.coord - 0.12*dt,0,100);
  if(specimen.health < 30) specimen.coord = clamp(specimen.coord - 0.02*dt,0,100);
  specimen.bp_sys = Math.round(clamp(110 + (specimen.hr - 300)*0.06, 60, 200));
  specimen.bp_dia = Math.round(clamp(70 + (specimen.hr - 300)*0.04, 40, 150));
  specimen.rr = Math.round(clamp(70 + ((100 - specimen.health)*0.4), 10, 200));

  // congenital visual hints
  if(specimen.mutation && Date.now() > specimen._maskUntil){
    const inter = specimen.mutation.intermittency;
    if(Math.random() < (specimen.mutation.effect.breathIrreg||0) * dt * 60) triggerBreathIrregular();
    if(specimen.mutation.visual === 'twitch' && Math.random() < inter * dt * 60) triggerTwitch();
    if(specimen.mutation.visual === 'headTilt' && Math.random() < inter * dt * 60) triggerHeadTilt();
    if(specimen.mutation.visual === 'confuse' && Math.random() < inter * dt * 60) triggerConfuse();
    if(specimen.mutation.visual === 'paleEar' && Math.random() < inter * dt * 60) triggerPaleEar();
  }

  // death
  if(specimen.health <= 0 && !specimen._dead){
    specimen._dead = true; log('Specimen expired (simulation). Post-mortem generated.'); showPostMortem();
  }
// history push (timestamp in seconds since spawn)
  specimen.t = Math.round((specimen.t || 0) + dt);
  history.push({t: specimen.t, health: specimen.health, coord: specimen.coord, hr: specimen.hr});
  // remove very old points older than a safety cap (keeps memory bounded)
  const safetyMax = 3600 * 6; // 6 hours safety cap
  if(history.length && history[0].t < specimen.t - safetyMax){
    while(history.length && history[0].t < specimen.t - safetyMax) history.shift();
  }

  updateUI(); drawChart();
  requestAnimationFrame(loop);
}

// Init
spawn();
loop();

// Expose for debug
window._lab1 = { spawn, specimen, active, history, DRUGS, CONGENITAL_POOL, windowSeconds };

</script>
</body>
</html>
